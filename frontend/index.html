<!DOCTYPE html>
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Sizuka</title>
    <script src="static/vue-2.5.13.js"></script>
    <script src="static/axios.js"></script>
    <script src="static/js.cookie.min.js"></script>

    <!-- import stylesheet -->
    <link rel="stylesheet" href="//unpkg.com/iview/dist/styles/iview.css">
    <!-- import iView -->
    <script src="//unpkg.com/iview/dist/iview.min.js"></script>
</head>
<body>
<div id="app">
    <Row>
        <i-col span="2">&nbsp;</i-col>
        <i-col span="20" style="padding: 20px;border-bottom: 1px solid gray;">
            <Row>
                <i-col span="18">
                    <h1>Sizuka - Aliyun OSS Static Content Services</h1>
                </i-col>
                <i-col span="6" style="text-align: right">
                    <i-button v-on:click="setToken">Identity Setting</i-button>
                </i-col>
            </Row>
        </i-col>
        <i-col span="2">&nbsp;</i-col>
    </Row>
    <Row>
        <i-col span="2">&nbsp;</i-col>
        <i-col span="20" style="padding: 20px;border-bottom: 1px solid gray;">
            <Row style="margin: 20px 0">
                <i-col span="12">
                    <h2>
                        Explorer
                        &nbsp;&nbsp;
                        <small>Cached on {{cache_time}}</small>
                    </h2>
                </i-col>
                <i-col span="12" style="text-align: right">
                    <!--
                    <i-input v-model="path_input">
                        <i-button slot="append" icon="ios-search" v-on:click="explore"></i-button>
                    </i-input>
                    -->
                    <i-button type="ghost" icon="refresh" v-on:click="explore(true)" style="display: inline-block">Force
                        Update
                    </i-button>
                    &nbsp;&nbsp;
                    <i-button icon="ios-search" v-on:click="explore(false)">Refresh</i-button>
                </i-col>
            </Row>
            <Row>
                <i-col span="24">
                    <Alert type="error" v-if="message.length>0">{{message}}</Alert>
                </i-col>
            </Row>
            <Row>
                <i-col span="24">
                    <Tree :data="object_tree" @on-select-change="open_object"></Tree>
                </i-col>
            </Row>
        </i-col>
        <i-col span="2">&nbsp;</i-col>
    </Row>
    <Row>
        <i-col span="2">&nbsp;</i-col>
        <i-col span="20" style="padding: 20px;text-align: center">
            <p>Copyright 2018 Sinri Edogawa</p>
            <p>
                Donation with
                bitcoin: 18wCjV8mnepDpLzASKdW7CGo6U8F9rPuV4
            </p>
        </i-col>
        <i-col span="2">&nbsp;</i-col>
    </Row>
</div>
<script>
    let app = new Vue({
        el: '#app',
        data: {
            cache_time: '',
            path: '',
            path_input: '',
            object_tree: [],
            message: '',
        },
        methods: {
            explore: function (ignore_cache) {
                if (Cookies.get("sizuka_token")) {
                    axios.get(
                        '../Api/explorer?force_update=' + (ignore_cache ? 'YES' : 'NO')
                    ).then((res) => {
                        console.log('success', res);
                        if (res.data.code !== 'OK') {
                            //alert('Explore Failed!');
                            this.message = res.data.data;
                        } else {
                            let tree = res.data.data.tree;
                            this.object_tree = tree.children;
                            this.cache_time = res.data.data.cache_time;
                            this.message = '';
                        }
                    }).catch((res) => {
                        console.log('error', res);
                        this.message = 'ajax error';
                    });
                } else {
                    this.message = "Token needed!";
                }
            },
            open_object: function (node) {
                console.log("open_object", node[0].path);
                window.open("../proxy/" + node[0].path);
            },
            setToken: function () {
                let token = prompt("Set your identity token here. If you want to clean the token, just leave this empty and confirm.");
                if (token === '') {
                    Cookies.remove('sizuka_token');
                } else {
                    Cookies.set('sizuka_token', token, {expires: 1});
                }
            }
        },
        mounted: function () {
            this.path = "";
            this.path_input = "";
            this.explore();
        },
    })
</script>
</body>
</html>